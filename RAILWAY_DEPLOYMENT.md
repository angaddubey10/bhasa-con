# BhasaConnect - Railway Deployment Guide

## Overview

BhasaConnect is deployed on Railway using a multi-service architecture with optimized build configurations and automatic database migrations.

## Architecture

```
Railway Project
├── postgres (PostgreSQL Database)
├── bhasaconnect-backend (FastAPI API)
└── bhasaconnect-frontend (React SPA)
```

## Configuration Files

### 1. railway.json
Basic Railway project configuration:
```json
{
  "$schema": "https://railway.app/railway.schema.json"
}
```

Railway automatically detects services based on:
- Root directories with nixpacks.toml configurations
- Service dependencies defined in nixpacks.toml
- Environment variables set in Railway dashboard

### 2. backend/nixpacks.toml
Backend service configuration with:
- Python 3.11 runtime optimization
- Automatic database migrations
- Health check configuration
- Build optimization with pip caching

### 3. frontend/nixpacks.toml  
Frontend service configuration with:
- Node.js 18 runtime
- Vite build optimization
- Static asset serving
- Development dependency pruning

## Deployment Process

### Prerequisites
1. Railway account with GitHub repository connected
2. Environment variables configured in Railway dashboard
3. Repository pushed to GitHub

### Step 1: Initial Setup
```bash
# Install Railway CLI (optional)
npm install -g @railway/cli

# Login to Railway (if using CLI)
railway login
```

### Step 2: Environment Variables
Set these variables in Railway dashboard under each service:

**Global Variables** (set at project level):
- `SECRET_KEY`: Generate a secure random string
- `POSTGRES_PASSWORD`: Auto-generated by Railway
- `CLOUDINARY_CLOUD_NAME`: Your Cloudinary cloud name
- `CLOUDINARY_API_KEY`: Your Cloudinary API key  
- `CLOUDINARY_API_SECRET`: Your Cloudinary API secret

### Step 3: Deploy
1. Connect your GitHub repository to Railway
2. Add PostgreSQL database service manually:
   - Click "Add Service" → "Database" → "PostgreSQL"
3. Railway will automatically detect nixpacks.toml configurations:
   - Backend service from `/backend` directory
   - Frontend service from `/frontend` directory  
4. Database migrations run automatically on backend deployment

### Step 4: Verify Deployment
Check the following:
- [ ] All services are running (green status in Railway dashboard)
- [ ] Backend health check passes at `/health`
- [ ] Frontend loads correctly
- [ ] API calls work between frontend and backend
- [ ] Database migrations completed successfully
- [ ] File uploads work with Cloudinary

## Build Optimizations

### Backend (nixpacks.toml)
- Python 3.11 runtime with optimized packages
- No-cache pip installations for smaller image
- Bytecode compilation for faster startup
- Automatic database migrations on deployment
- Health check configuration

### Frontend (nixpacks.toml) 
- Node.js 18 runtime
- Optimized npm installation and build
- Production build with Vite
- Static asset serving configuration
- Development dependencies pruning after build

## Monitoring & Health Checks

### Backend Health Check
- **Endpoint**: `GET /health`
- **Response**: `{"status": "healthy", "service": "bhasaconnect-backend"}`
- **Interval**: 30 seconds
- **Timeout**: 30 seconds

### Frontend Health Check
- **Endpoint**: `GET /`
- **Interval**: 30 seconds  
- **Timeout**: 30 seconds

## Troubleshooting

### Common Issues

**Database Connection Errors**
- Verify `DATABASE_URL` is properly injected
- Check postgres service is running
- Ensure backend service has postgres dependency

**CORS Errors**
- Verify `CORS_ORIGINS` includes Railway frontend domain
- Check frontend and backend are on same Railway project
- Confirm environment variable injection is working

**Build Failures**
- Check nixpacks.toml syntax
- Verify all dependencies in requirements.txt/package.json
- Review build logs in Railway dashboard

**Migration Errors**  
- Check database connection is available during startup
- Verify alembic configuration is correct
- Review migration files for syntax errors

### Useful Commands

```bash
# View service logs (if using Railway CLI)
railway logs --service=bhasaconnect-backend
railway logs --service=bhasaconnect-frontend

# Connect to database (if using Railway CLI)
railway run psql

# Redeploy specific service
railway up --service=bhasaconnect-backend
```

## Scaling Considerations

- **Backend**: Single worker recommended for start, can scale horizontally
- **Database**: Railway managed PostgreSQL handles scaling automatically  
- **Frontend**: Served as static files, scales with Railway's CDN
- **File Storage**: Cloudinary handles all file operations

## Security Features

- **HTTPS**: Automatic SSL certificates from Railway
- **Environment Variables**: Encrypted and injected at runtime
- **Database**: Private networking between services
- **CORS**: Properly configured for Railway domains only
- **JWT**: Secure token-based authentication

## Cost Optimization

- **Sleep Policy**: Disabled for production availability
- **Resource Limits**: Set appropriate CPU/memory limits
- **Build Caching**: Optimized with nixpacks configurations
- **Static Assets**: Served efficiently via Railway's CDN

### Frontend Service  
- **Framework**: React + Vite
- **Build**: Static site generation
- **Port**: 3000

## Environment Variables

### Backend (.env)
```
DATABASE_URL=postgresql://username:password@host:port/database
JWT_SECRET=your-super-secret-jwt-key-min-32-characters
CLOUDINARY_CLOUD_NAME=your-cloudinary-cloud-name
CLOUDINARY_API_KEY=your-cloudinary-api-key
CLOUDINARY_API_SECRET=your-cloudinary-api-secret
CORS_ORIGINS=https://your-frontend-domain.railway.app
ENVIRONMENT=production
```

### Frontend (.env)
```
VITE_API_URL=https://your-backend-domain.railway.app
VITE_ENVIRONMENT=production
```

## Deployment Commands

### Backend
```bash
# Install dependencies
pip install -r requirements.txt

# Run database migrations
alembic upgrade head

# Start server
uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

### Frontend
```bash
# Install dependencies
npm ci

# Build for production
npm run build

# Serve built files
npm run preview -- --host 0.0.0.0 --port $PORT
```

## Database Setup
Railway will automatically provision a PostgreSQL database. The connection URL will be provided via the `DATABASE_URL` environment variable.

## Custom Domains
Both services can be configured with custom domains through Railway dashboard:
- Backend: `api.yourdomain.com`
- Frontend: `yourdomain.com`